x-common-image-policy: &image-policy
  pull_policy: missing  # –°–∫–∞—á–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–±—Ä–∞–∑–∞ –Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ

services:
  # ============================================================================
  # PostgreSQL Database
  # ============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: news-aggregator-db
    restart: unless-stopped
    <<: *image-policy
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-newsaggregator}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme123}
      POSTGRES_DB: ${POSTGRES_DB:-news_aggregator}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5433}:5433"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-newsaggregator} -d ${POSTGRES_DB:-news_aggregator}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - news-aggregator-network

  # ============================================================================
  # Redis Cache/Log Storage
  # ============================================================================
  redis:
    image: redis:latest
    container_name: news-aggregator-redis
    restart: unless-stopped
    <<: *image-policy
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - news-aggregator-network

  # ============================================================================
  # Qdrant Vector Database
  # ============================================================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: news-aggregator-qdrant
    restart: unless-stopped
    <<: *image-policy
    environment:
      QDRANT__TELEMETRY_DISABLED: "true"
      QDRANT__LOG_LEVEL: INFO
    ports:
      - "${QDRANT_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - ./project_data/qdrant:/qdrant/storage
    networks:
      - news-aggregator-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6333/readyz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================================================
  # Ollama LLM Server
  # ============================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: news-aggregator-ollama
    restart: unless-stopped
    <<: *image-policy
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      OLLAMA_HOST: "0.0.0.0:11434"
      OLLAMA_NUM_GPU: ${OLLAMA_NUM_GPU:-1}
      OLLAMA_MAX_LOADED_LAYERS: ${OLLAMA_MAX_LOADED_LAYERS:-20}
      OLLAMA_TELEMETRY: "false"
      OLLAMA_KEEP_ALIVE: "24h"
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ./project_data/ollama:/root/.ollama
    networks:
      - news-aggregator-network
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    runtime: nvidia

  # ============================================================================
  # Ollama Model Initializer (one-time setup)
  # ============================================================================
  ollama-init:
    image: ollama/ollama:latest
    container_name: news-aggregator-ollama-init
    <<: *image-policy
    volumes:
      - ./project_data/ollama:/root/.ollama
      - ./scripts/ollama-models.txt:/tmp/models.txt:ro
    networks:
      - news-aggregator-network
    environment:
      OLLAMA_HOST: "http://ollama:11434"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "=============================================="
        echo "ü§ñ Ollama Model Initialization"
        echo "=============================================="
        
        # –ñ–¥—ë–º –ø–æ–ª–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Ollama
        echo "‚è≥ Waiting for Ollama server..."
        sleep 10
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        until ollama list >/dev/null 2>&1; do
          echo "   Ollama not ready, retrying in 5s..."
          sleep 5
        done
        
        echo "‚úì Ollama server is ready!"
        echo ""
        
        # –¢–µ–∫—É—â–∏–µ –º–æ–¥–µ–ª–∏
        echo "üìã Current models:"
        ollama list
        echo ""
        
        # ============================================
        # Embeddings model (REQUIRED)
        # ============================================
        MODEL="nomic-embed-text"
        if ollama list | grep -q "$$MODEL"; then
          echo "‚úì $$MODEL already installed"
        else
          echo "üì• Installing $$MODEL (274MB, ~1 min)..."
          ollama pull $$MODEL && echo "‚úì $$MODEL installed" || echo "‚úó Failed to install $$MODEL"
        fi
        
        echo ""
        
        # ============================================
        # Main LLM model
        # ============================================
        MODEL="${LLM_MODEL:-gpt-oss:20b}"
        if ollama list | grep -q "$$MODEL"; then
          echo "‚úì $$MODEL already installed"
        else
          echo "=============================================="
          echo "üì• Installing $$MODEL"
          echo "‚è±Ô∏è  This may take 30-40 minutes (~13GB)"
          echo "=============================================="
          ollama pull $$MODEL && echo "‚úì $$MODEL installed" || echo "‚úó Failed to install $$MODEL"
        fi
        
        echo ""
        echo "=============================================="
        echo "üìä Final model list:"
        echo "=============================================="
        ollama list
        echo ""
        echo "‚úÖ Ollama initialization complete!"
        echo "=============================================="
    restart: "no"

  # ============================================================================
  # Main Application (Streamlit)
  # ============================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      # –õ–æ–∫–∞–ª—å–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ registry
#      cache_from:
#        - news-aggregator-app:latest
#    image: news-aggregator-app:latest
    container_name: news-aggregator-app
    restart: unless-stopped
    environment:
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-newsaggregator}:${POSTGRES_PASSWORD:-changeme123}@postgres:5432/${POSTGRES_DB:-news_aggregator}

      # Redis
      REDIS_URL: redis://redis:6379/0

      # Reddit API
      REDDIT_CLIENT_ID: ${REDDIT_CLIENT_ID}
      REDDIT_CLIENT_SECRET: ${REDDIT_CLIENT_SECRET}
      REDDIT_USER_AGENT: ${REDDIT_USER_AGENT:-NewsAggregator/1.0}

      # Telegram API
      TELEGRAM_API_ID: ${TELEGRAM_API_ID}
      TELEGRAM_API_HASH: ${TELEGRAM_API_HASH}
      TELEGRAM_PHONE: ${TELEGRAM_PHONE}

      # Services
      QDRANT_URL: http://qdrant:6333
      OLLAMA_BASE_URL: http://ollama:11434
      STABLE_DIFFUSION_URL: http://stable-diffusion:7860

      # App config
      PYTHONUNBUFFERED: 1
      TZ: ${TZ:-UTC}
      STREAMLIT_SERVER_PORT: 8501
      STREAMLIT_SERVER_ADDRESS: 0.0.0.0
      STREAMLIT_BROWSER_GATHER_USAGE_STATS: false
    ports:
      - "${APP_PORT:-8501}:8501"
    volumes:
      - ./.env:/app/.env:ro  # Mount .env
      - ./src:/app/src:ro
      - ./config:/app/config:ro
      - ./project_data/app_logs:/app/logs
      - ./project_data/app_data:/app/data
    networks:
      - news-aggregator-network
    depends_on:
      - postgres
      - redis

  # ============================================================================
  # FastAPI Backend (REST API)
  # ============================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: news-aggregator-api
    restart: unless-stopped
    environment:
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-newsaggregator}:${POSTGRES_PASSWORD:-changeme123}@postgres:5432/${POSTGRES_DB:-news_aggregator}

      # Redis
      REDIS_URL: redis://redis:6379/0

      # Services
      QDRANT_URL: http://qdrant:6333
      OLLAMA_BASE_URL: http://ollama:11434

      # App config
      PYTHONUNBUFFERED: 1
      PYTHONPATH: /app
      TZ: ${TZ:-UTC}
    ports:
      - "8000:8000"
    volumes:
      - ./.env:/app/.env:ro
      - ./src:/app/src
      - ./config:/app/config:ro
      - ./project_data/api_logs:/app/logs
    networks:
      - news-aggregator-network
    depends_on:
      - postgres
      - redis
      - qdrant
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================================
  # n8n Automation
  # ============================================================================
  n8n:
    image: n8nio/n8n:latest
    container_name: news-aggregator-n8n
    restart: unless-stopped
    <<: *image-policy
    environment:
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${N8N_DB:-n8n}
      DB_POSTGRESDB_USER: ${POSTGRES_USER:-newsaggregator}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD:-changeme123}
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE:-true}
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER:-admin}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD:-changeme123}
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: "true"
      N8N_DB_RETRY_ATTEMPTS: 10
      N8N_DB_RETRY_WAIT_MS: 5000
      TZ: ${TZ:-UTC}
      N8N_RUNNERS_ENABLED: true
      N8N_BLOCK_ENV_ACCESS_IN_NODE: false
      N8N_GIT_NODE_DISABLE_BARE_REPOS: true
    ports:
      - "${N8N_PORT:-5678}:5678"
    volumes:
      - ./project_data/n8n:/home/node/.n8n
    networks:
      - news-aggregator-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # Adminer (Database UI)
  # ============================================================================
  adminer:
    image: adminer:latest
    container_name: news-aggregator-adminer
    restart: unless-stopped
    <<: *image-policy
    ports:
      - "${ADMINER_PORT:-8080}:8080"
    networks:
      - news-aggregator-network

  # ============================================================================
  # Stable Diffusion WebUI (Image Generation)
  # ============================================================================
#  stable-diffusion:
#    image: ghcr.io/ai-dock/stable-diffusion-webui:v2-cuda--22.04-v1.10.1
#    container_name: news-aggregator-sd
#    restart: unless-stopped
#    <<: *image-policy
#    deploy:
#      resources:
#        reservations:
#          devices:
#            - driver: nvidia
#              count: 1
#              capabilities: [gpu]
#    environment:
#      # –û—Ç–∫–ª—é—á–∞–µ–º Cloudflare Tunnel
#      QUICKTUNNELS: "false"
#      DIRECT_ADDRESS: "0.0.0.0"
#      DIRECT_ADDRESS_GET_WAN: "false"
#
#      # Stable Diffusion settings
#      CLI_ARGS: "--allow-code --medvram --xformers --enable-insecure-extension-access --api --no-half-vae --skip-torch-cuda-test --listen"
#      WEBUI_PORT: 7860
#
#      # GPU settings
#      NVIDIA_VISIBLE_DEVICES: all
#      NVIDIA_DRIVER_CAPABILITIES: compute,utility
#
#      # Performance
#      AUTO_UPDATE: "false"
#      WEB_ENABLE_AUTH: "false"
#      SUPERVISOR_LOG_LEVEL: "warn"
#    ports:
#      - "${SD_PORT:-7860}:7860"
#    volumes:
#      - ./project_data/stable_diffusion/models:/stable-diffusion-webui/models
#      - ./project_data/stable_diffusion/embeddings:/stable-diffusion-webui/embeddings
#      - ./project_data/stable_diffusion/outputs:/stable-diffusion-webui/outputs
#      - ./project_data/stable_diffusion/extensions:/stable-diffusion-webui/extensions
#      - ./project_data/stable_diffusion/config:/stable-diffusion-webui/config
#    networks:
#      - news-aggregator-network
#    runtime: nvidia
#    healthcheck:
#      test: ["CMD", "curl", "-f", "http://localhost:7860"]
#      interval: 30s
#      timeout: 10s
#      retries: 5
#      start_period: 180s
#    pull_policy: if_not_present
#    profiles: []    # - full  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å --profile full

# ==============================================================================
# Networks
# ==============================================================================
networks:
  news-aggregator-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local